name: Publish Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    permissions:
      contents: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: universal-apple-darwin
            config: '{"bundle":{"targets":["app","dmg"]}}'
            name: macOS

          - platform: ubuntu-22.04
            target: ""
            config: '{"bundle":{"targets":["deb","appimage"]}}'
            name: Linux

          - platform: windows-latest
            target: "x86_64-pc-windows-msvc"
            # âœ… å…³é”®ä¿®å¤ï¼šæŠŠ "zh-CN" æ”¹ä¸º "SimpChinese"
            config: '{"bundle":{"targets":["nsis"],"windows":{"nsis":{"installMode":"perMachine","languages":["SimpChinese"],"displayLanguageSelector":false}}}}'
            name: Windows

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clean Cargo proxy config
        shell: bash
        run: rm -rf ~/.cargo/config* .cargo/config* || true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
          cache-on-failure: true

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev libgtk-3-dev libayatana-appindicator3-dev \
            librsvg2-dev patchelf build-essential curl wget file libssl-dev libxdo-dev

      - name: Install frontend dependencies
        run: npm ci

      # ç”ŸæˆåŠ¨æ€é…ç½®ï¼ˆWindows å·²ä½¿ç”¨ SimpChineseï¼‰
      - name: Generate platform-specific Tauri config
        run: echo '${{ matrix.config }}' > tauri-build-config.json

      # æ„å»º + å‘å¸ƒ Release
      - name: Build Tauri app & create GitHub Release
        uses: tauri-apps/tauri-action@v0.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: "SafeMask ${{ github.ref_name }}"
          releaseBody: |
            ğŸš€ **SafeMask ${{ github.ref_name }}** å·²å‘å¸ƒï¼

            **ä¸‹è½½åœ°å€** è¯·è§ä¸‹æ–¹ Assetsã€‚
          releaseDraft: true
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') || contains(github.ref_name, 'alpha') }}
          args: --config tauri-build-config.json ${{ matrix.target != '' && format('--target {0}', matrix.target) || '' }}
          
      - name: Create Windows Portable ZIP
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          $target = "${{ matrix.target }}"
          
          # 1. å‡†ç¡®å®šä½ç¼–è¯‘äº§ç‰©ç›®å½•
          $basePath = if ($target) { "target\$target\release" } else { "target\release" }
          $rawExe = Join-Path $basePath "SafeMask.exe"
          
          Write-Host "æ£€æŸ¥è·¯å¾„: $rawExe"

          if (-not (Test-Path $rawExe)) {
              Write-Error "æ‰¾ä¸åˆ°æ ¸å¿ƒæ‰§è¡Œæ–‡ä»¶ SafeMask.exeï¼Œæ‰“åŒ…ä¸­æ­¢ï¼"
              Get-ChildItem -Path "target" -Recurse -Depth 4
              exit 1
          }

          # 2. åˆ›å»ºä¾¿æºç‰ˆæ–‡ä»¶å¤¹
          $portableDir = "SafeMask_${version}_Portable_x64"
          New-Item -ItemType Directory -Path $portableDir -Force

          # 3. æ‹·è´æ ¸å¿ƒæ–‡ä»¶
          Copy-Item -Path $rawExe -Destination "$portableDir\SafeMask.exe"

          # 4. æ‹·è´å¿…è¦ç›®å½• (å¦‚æœå­˜åœ¨)
          # resources æ–‡ä»¶å¤¹é€šå¸¸åŒ…å«ä½ æ‰“åŒ…è¿›å»çš„å¤–éƒ¨èµ„æº
          if (Test-Path (Join-Path $basePath "resources")) {
              Write-Host "å‘ç° resources ç›®å½•ï¼Œæ­£åœ¨æ‹·è´..."
              Copy-Item -Path (Join-Path $basePath "resources") -Destination $portableDir -Recurse
          }
          
          # _upd æ–‡ä»¶å¤¹ï¼ˆå¦‚æœå¼€å¯äº†æ›´æ–°åŠŸèƒ½ï¼ŒæŸäº›ç‰ˆæœ¬å¯èƒ½éœ€è¦ï¼‰
          if (Test-Path (Join-Path $basePath "_upd")) {
              Copy-Item -Path (Join-Path $basePath "_upd") -Destination $portableDir -Recurse
          }

          # 5. æ£€æŸ¥å¹¶å¤„ç† Sidecars (å¦‚æœæœ‰)
          # Tauri çš„ sidecar é€šå¸¸ç›´æ¥æ”¾åœ¨ exe åŒçº§ï¼Œåç§°å¸¦æœ‰ target åç¼€
          # è¿™é‡Œé€šè¿‡åŒ¹é…æ’é™¤æ‰ä¸»è¦çš„ exeï¼Œæ‹·è´å…¶ä»–å¯èƒ½çš„æ‰§è¡Œæ–‡ä»¶
          Get-ChildItem -Path $basePath -Filter "*.exe" | Where-Object { $_.Name -ne "SafeMask.exe" -and $_.Name -notlike "*setup*" } | ForEach-Object {
              Write-Host "å‘ç°ç–‘ä¼¼ Sidecar æˆ–ä¾èµ–æ–‡ä»¶: $($_.Name)"
              Copy-Item -Path $_.FullName -Destination $portableDir
          }

          # 6. å‹ç¼©å¹¶ä¸Šä¼ 
          $zipPath = "${portableDir}.zip"
          Compress-Archive -Path "$portableDir\*" -DestinationPath $zipPath -Force
          
          Write-Host "ä¾¿æºç‰ˆæ‰“åŒ…å®Œæˆ: $zipPath"
          gh release upload ${{ github.ref_name }} "$zipPath#Windows_Portable_x64" --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}