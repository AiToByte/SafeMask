name: Publish Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    permissions:
      contents: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: universal-apple-darwin
            config: '{"bundle":{"targets":["app","dmg"]}}'
            name: macOS

          - platform: ubuntu-22.04
            target: ""
            config: '{"bundle":{"targets":["deb","appimage"]}}'
            name: Linux

          - platform: windows-latest
            target: "x86_64-pc-windows-msvc"
             # âœ… ä¿®å¤ï¼šç§»é™¤äº†ä¸æ”¯æŒçš„ "type":"portable"ï¼Œå›å½’æ ‡å‡† NSIS é…ç½®
            config: '{"bundle":{"targets":["nsis"],"windows":{"nsis":{"installMode":"perMachine","languages":["SimpChinese"],"displayLanguageSelector":false}}}}'
            name: Windows

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clean Cargo proxy config
        shell: bash
        run: rm -rf ~/.cargo/config* .cargo/config* || true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          # ä»…åœ¨éœ€è¦æ—¶å®‰è£…ç‰¹å®š target
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || (matrix.target != '' && matrix.target || '') }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
          cache-on-failure: true

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev libgtk-3-dev libayatana-appindicator3-dev \
            librsvg2-dev patchelf build-essential curl wget file libssl-dev libxdo-dev

      - name: Install frontend dependencies
        run: npm ci

      # ç”ŸæˆåŠ¨æ€é…ç½®ï¼ˆWindows å·²ä½¿ç”¨ SimpChineseï¼‰
      - name: Generate platform-specific Tauri config
        run: echo '${{ matrix.config }}' > tauri-build-config.json

      # æ„å»ºä¸»ä½“ï¼ˆåŒ…å«å®‰è£…åŒ…å’Œä¾¿æºç‰ˆï¼‰
      - name: Build Tauri app & create GitHub Release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: "SafeMask ${{ github.ref_name }}"
          releaseBody: |
            ğŸš€ **SafeMask ${{ github.ref_name }}** ç°å·²æ­£å¼å‘å¸ƒï¼
            
            SafeMask æ˜¯ä¸€æ¬¾åŸºäº Rust æ„å»ºçš„é«˜æ€§èƒ½æœ¬åœ°éšç§è„±æ•å·¥å…·ï¼Œç¡®ä¿æ‚¨çš„æ•æ„Ÿæ•°æ®åœ¨æ‹¥æŠ± AI çš„åŒæ—¶ï¼Œéšç§ä¸å‡ºåŸŸã€‚

            ### ğŸ“¦ å„å¹³å°ä¸‹è½½æŒ‡å— / Download Guide

            #### ğŸªŸ Windows
            - **æ ‡å‡†å®‰è£…ç‰ˆ (`SafeMask_x64-setup.exe`)**: å»ºè®®å¤§å¤šæ•°ç”¨æˆ·ä½¿ç”¨ï¼Œæ”¯æŒå¿«æ·æ–¹å¼å’Œè‡ªåŠ¨æ›´æ–°ã€‚
            - **å•æ–‡ä»¶ä¾¿æºç‰ˆ (`SafeMask_Portable_x64.zip`)**: æ— éœ€å®‰è£…ï¼ŒåŒå‡»å³ç”¨ï¼Œé€‚åˆ U ç›˜æˆ–å¿«é€Ÿä½¿ç”¨ã€‚

            #### ğŸ macOS
            - **ç£ç›˜æ˜ åƒ (`.dmg`)**: é€šç”¨äºŒè¿›åˆ¶ç‰ˆæœ¬ï¼Œæ”¯æŒ Apple Silicon (M1/M2/M3/M4) å’Œ Intel èŠ¯ç‰‡ã€‚

            #### ğŸ§ Linux
            - **é€šç”¨ç‰ˆ (`.AppImage`)**: èµ‹äºˆæƒé™å³å¯è¿è¡Œã€‚
            - **å®‰è£…åŒ… (`.deb`)**: é€‚ç”¨äº Ubuntu/Debianã€‚

            ---
            ### ğŸ” å®‰å…¨æ‰¿è¯º / Security
            - **100% Local**: æ‰€æœ‰è„±æ•è®¡ç®—å‡åœ¨æœ¬åœ°å®Œæˆã€‚å¼•æ“æ— ä»»ä½•ç½‘ç»œæƒé™ï¼Œæ•°æ®ç»å¯¹å®‰å…¨ã€‚

            ---
            *æ„Ÿè°¢ä½¿ç”¨ SafeMaskï¼*
          releaseDraft: true
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') || contains(github.ref_name, 'alpha') }}
          args: --config tauri-build-config.json ${{ matrix.target != '' && format('--target {0}', matrix.target) || '' }}
          
       # åˆ¶ä½œ Windows å…å®‰è£… ZIP (ä¿®å¤è·¯å¾„å¹¶åŒ…å« resources æ–‡ä»¶å¤¹)
      - name: Create Windows Portable ZIP
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          $target = "${{ matrix.target }}"
          
          # 1. å®šä½äº§ç‰©è·¯å¾„ (è€ƒè™‘åˆ°æŒ‡å®šçš„ target triple)
          $basePath = "target\$target\release"
          $exePath = Join-Path $basePath "SafeMask.exe"
          $rulesPath = Join-Path $basePath "rules"
          $customPath = Join-Path $basePath "custom"
          $iconsPath = Join-Path $basePath "icons"

          Write-Host "æ£€æŸ¥æ ¸å¿ƒæ–‡ä»¶: $exePath"
          if (-not (Test-Path $exePath)) {
              Write-Error "æ‰¾ä¸åˆ° SafeMask.exe"
              exit 1
          }

          # 2. åˆ›å»ºæ‰“åŒ…ç›®å½•
          $portableName = "SafeMask_${version}_Portable_x64"
          $zipPath = "${portableName}.zip"
          New-Item -ItemType Directory -Path $portableName -Force

          # 3. æ‹·è´æ ¸å¿ƒæ‰§è¡Œæ–‡ä»¶
          Copy-Item -Path $exePath -Destination "$portableName\SafeMask.exe"

          # 4. ğŸš€ å…³é”®ä¿®å¤ï¼šå¿…é¡»æ‹·è´æ‰€æœ‰èµ„æºæ–‡ä»¶å¤¹
          # ä½ çš„ Rust ä»£ç åŠ è½½è§„åˆ™æ—¶ expect äº†èµ„æºè·¯å¾„ï¼Œæ²¡æœ‰è¿™ä¸ªæ–‡ä»¶å¤¹å¿…å®šé—ªé€€
          if (Test-Path $rulesPath) {
              Write-Host "æ­£åœ¨æ‹·è´èµ„æºæ–‡ä»¶å¤¹: $rulesPath"
              Copy-Item -Path $rulesPath -Destination $portableName -Recurse -Force
          } else {
              Write-Warning "æœªæ‰¾åˆ° rules æ–‡ä»¶å¤¹ï¼Œç¨‹åºè¿è¡Œå¯èƒ½ä¼šé—ªé€€ï¼"
          }
          if (Test-Path $customPath) {
              Write-Host "æ­£åœ¨æ‹·è´èµ„æºæ–‡ä»¶å¤¹: $customPath"
              Copy-Item -Path $customPath -Destination $portableName -Recurse -Force
          } else {
              Write-Warning "æœªæ‰¾åˆ° custom æ–‡ä»¶å¤¹ï¼Œç¨‹åºè¿è¡Œå¯èƒ½ä¼šé—ªé€€ï¼"
          }
          if (Test-Path $iconsPath) {
              Write-Host "æ­£åœ¨æ‹·è´èµ„æºæ–‡ä»¶å¤¹: $iconsPath"
              Copy-Item -Path $iconsPath -Destination $portableName -Recurse -Force
          } else {
              Write-Warning "æœªæ‰¾åˆ° icons æ–‡ä»¶å¤¹ï¼Œç¨‹åºè¿è¡Œå¯èƒ½ä¼šé—ªé€€ï¼"
          }

          # 5. å‹ç¼©å¹¶ä¸Šä¼ 
          Compress-Archive -Path "$portableName\*" -DestinationPath $zipPath -Force
          Write-Host "æ­£åœ¨ä¸Šä¼ å…å®‰è£…ç‰ˆ ZIP..."
          gh release upload ${{ github.ref_name }} "$zipPath#Windows-Portable-x64" --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}