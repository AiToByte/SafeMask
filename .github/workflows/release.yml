name: Publish Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    permissions:
      contents: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: universal-apple-darwin
            config: '{"bundle":{"targets":["app","dmg"]}}'
            name: macOS

          - platform: ubuntu-22.04
            target: ""
            config: '{"bundle":{"targets":["deb","appimage"]}}'
            name: Linux

          - platform: windows-latest
            target: ""
            # âœ… å…³é”®ä¿®å¤ï¼šæŠŠ "zh-CN" æ”¹ä¸º "SimpChinese"
            config: '{"bundle":{"targets":["nsis"],"windows":{"nsis":{"installMode":"perMachine","languages":["SimpChinese"],"displayLanguageSelector":false}}}}'
            name: Windows

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clean Cargo proxy config
        shell: bash
        run: rm -rf ~/.cargo/config* .cargo/config* || true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
          cache-on-failure: true

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev libgtk-3-dev libayatana-appindicator3-dev \
            librsvg2-dev patchelf build-essential curl wget file libssl-dev libxdo-dev

      - name: Install frontend dependencies
        run: npm ci

      # ç”ŸæˆåŠ¨æ€é…ç½®ï¼ˆWindows å·²ä½¿ç”¨ SimpChineseï¼‰
      - name: Generate platform-specific Tauri config
        run: echo '${{ matrix.config }}' > tauri-build-config.json

      # æ„å»º + å‘å¸ƒ Release
      - name: Build Tauri app & create GitHub Release
        uses: tauri-apps/tauri-action@v0.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: "SafeMask ${{ github.ref_name }}"
          releaseBody: |
            ğŸš€ **SafeMask ${{ github.ref_name }}** å·²å‘å¸ƒï¼

            **ä¸‹è½½åœ°å€** è¯·è§ä¸‹æ–¹ Assetsã€‚
          releaseDraft: true
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') || contains(github.ref_name, 'alpha') }}
          args: --config tauri-build-config.json ${{ matrix.target != '' && format('--target {0}', matrix.target) || '' }}

      # Windows ä¾¿æºç‰ˆ ZIPï¼ˆç»¿è‰²å…å®‰è£…ï¼‰
      - name: Create Windows Portable ZIP
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          $portableDir = "SafeMask_${version}_Portable_x64"
          $zipPath = "${portableDir}.zip"

          Write-Output "å½“å‰ç‰ˆæœ¬: $version"
          Write-Output "æ­£åœ¨æœç´¢å¯èƒ½çš„ exe æ–‡ä»¶..."

          # æ‰©å±• candidatesï¼Œæ”¯æŒæ›´å¤šæ–‡ä»¶åå˜ä½“ï¼ˆå¿½ç•¥å¤§å°å†™ã€ç©ºæ ¼ã€ä¸‹åˆ’çº¿ç­‰ï¼‰
          $candidates = @(
            # æœ€å¸¸è§ NSIS è¾“å‡º
            "src-tauri/target/release/bundle/nsis/SafeMask_${version}_x64-setup.exe",
            "src-tauri/target/release/bundle/nsis/SafeMask_${version}_x64.exe",
            "src-tauri/target/release/bundle/nsis/SafeMask_x64-setup.exe",
            # å¯èƒ½æœ‰ç©ºæ ¼æˆ–ä¸åŒåˆ†éš”ç¬¦
            "src-tauri/target/release/bundle/nsis/*${version}*-setup.exe",
            "src-tauri/target/release/bundle/nsis/*${version}*.exe",
            # åŸå§‹äºŒè¿›åˆ¶ fallback
            "src-tauri/target/release/SafeMask.exe",
            "src-tauri/target/release/bundle/SafeMask.exe"
          )

          $exePath = $null

          # å…ˆå°è¯•ç²¾ç¡®åŒ¹é…
          foreach ($pattern in $candidates) {
            $found = Get-ChildItem -Path $pattern -File -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($found) {
              $exePath = $found.FullName
              Write-Output "ç²¾ç¡®åŒ¹é…æ‰¾åˆ° exe: $exePath"
              break
            }
          }

          # å¦‚æœç²¾ç¡®æ²¡æ‰¾åˆ°ï¼Œç”¨é€šé…ç¬¦æ¨¡ç³Šæœç´¢ bundle/nsis ä¸‹æ‰€æœ‰ .exe / -setup.exe
          if (-not $exePath) {
            Write-Output "ç²¾ç¡®åŒ¹é…å¤±è´¥ï¼Œå°è¯•æ¨¡ç³Šæœç´¢ bundle/nsis ç›®å½•..."
            $nsisDir = "src-tauri/target/release/bundle/nsis"
            if (Test-Path $nsisDir) {
              $possibleExes = Get-ChildItem -Path $nsisDir -Filter "*.exe" -File
              if ($possibleExes.Count -gt 0) {
                # ä¼˜å…ˆé€‰å¸¦ -setup.exe çš„
                $setupOne = $possibleExes | Where-Object { $_.Name -like "*-setup.exe" } | Select-Object -First 1
                if ($setupOne) {
                  $exePath = $setupOne.FullName
                  Write-Output "æ¨¡ç³ŠåŒ¹é…æ‰¾åˆ° setup exe: $exePath"
                } else {
                  $exePath = $possibleExes[0].FullName
                  Write-Output "æ‰¾åˆ°ç¬¬ä¸€ä¸ª exe: $exePath"
                }
              } else {
                Write-Output "nsis ç›®å½•å­˜åœ¨ï¼Œä½†é‡Œé¢æ²¡æœ‰ .exe æ–‡ä»¶"
              }
            } else {
              Write-Output "bundle/nsis ç›®å½•ä¸å­˜åœ¨ï¼"
            }
          }

          # æœ€ç»ˆ fallbackï¼šé€’å½’æœç´¢æ•´ä¸ª target/release ä¸‹çš„æ‰€æœ‰ .exe
          if (-not $exePath) {
            Write-Output "ä»æœªæ‰¾åˆ°ï¼Œé€’å½’åˆ—å‡º target/release ä¸‹æ‰€æœ‰ .exe æ–‡ä»¶ï¼š"
            Get-ChildItem -Path "src-tauri/target/release" -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue | ForEach-Object {
              Write-Output "å‘ç° exe: $($_.FullName) (å¤§å°: $($_.Length) bytes)"
            }
            throw "æ²¡æœ‰æ‰¾åˆ°ä»»ä½• .exe æ–‡ä»¶ã€‚è¯·æ£€æŸ¥ä¸Šé¢çš„æ—¥å¿—ï¼Œç¡®è®¤ NSIS æ„å»ºæ˜¯å¦çœŸçš„ç”Ÿæˆäº†å®‰è£…ç¨‹åºã€‚"
          }

          # æ‹·è´å¹¶é‡å‘½åï¼ˆç»Ÿä¸€å« SafeMask.exeï¼Œä¾¿äºç”¨æˆ·ä½¿ç”¨ï¼‰
          New-Item -ItemType Directory -Path $portableDir -Force | Out-Null
          Copy-Item -Path $exePath -Destination "$portableDir/SafeMask.exe" -Force
          Write-Output "å·²æ‹·è´ exe åˆ°ä¾¿æºç›®å½•: $portableDir/SafeMask.exe"

          # resources æ‹·è´ï¼ˆå¦‚æœæœ‰ï¼‰
          $resDir = "src-tauri/target/release/resources"
          if (Test-Path $resDir) {
            Copy-Item -Recurse -Force $resDir "$portableDir/resources"
            Write-Output "å·²æ‹·è´ resources ç›®å½•"
          }

          Compress-Archive -Path "$portableDir\*" -DestinationPath $zipPath -Force
          Write-Output "ZIP æ‰“åŒ…å®Œæˆ: $zipPath"

          gh release upload ${{ github.ref_name }} $zipPath --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}