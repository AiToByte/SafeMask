name: "Publish Release"

on:
  push:
    tags:
      - 'v*' # å½“æ¨é€åˆ°ä»¥ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v1.1.2

jobs:
  publish-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "macos-latest" # macOS (Intel & Apple Silicon)
            args: "--target universal-apple-darwin"
          - platform: "ubuntu-22.04" # Linux
            args: ""
          - platform: "windows-latest" # Windows
            args: ""

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4
      
       # ğŸš€ æ–°å¢æ­¥éª¤ï¼šç§»é™¤æœ¬åœ°ä»£ç†é…ç½®ï¼Œé˜²æ­¢ CI ç¯å¢ƒè¿æ¥å¤±è´¥
      - name: Remove local cargo proxy
        run: |
          if [ -d ".cargo" ]; then
            rm -rf .cargo
            echo "Removed .cargo directory to prevent proxy errors in CI"
          fi
        shell: bash

      # 1. ç¯å¢ƒå‡†å¤‡ï¼šNode.js
      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # 2. ç¯å¢ƒå‡†å¤‡ï¼šRust
      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          # é’ˆå¯¹ macOS éœ€è¦æ·»åŠ  aarch64 ç›®æ ‡ä»¥æ”¯æŒ Universal äºŒè¿›åˆ¶
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      # 3. Rust ç¼–è¯‘ç¼“å­˜ï¼ˆå¤§å¹…æå‡äºŒæ¬¡æ‰“åŒ…é€Ÿåº¦ï¼‰
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      # 4. å®‰è£… Linux å¿…è¦çš„ç³»ç»Ÿä¾èµ– (Tauri v2 ä¸“ç”¨)
      - if: matrix.platform == 'ubuntu-22.04'
        name: install dependencies (ubuntu only)
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget file libxdo-dev libssl-dev libayatana-appindicator3-dev librsvg2-dev

      # 5. å®‰è£…å‰ç«¯ä¾èµ–
      - name: install frontend dependencies
        run: npm install

       # ğŸš€ å…³é”®æ­¥éª¤ï¼šåœ¨ Windows ä¸ŠåŠ¨æ€ä¿®æ”¹é…ç½®ä»¥ç”Ÿæˆå•æ–‡ä»¶ä¾¿æºç‰ˆ
      - name: Configure Windows Portable Mode
        if: matrix.platform == 'windows-latest'
        shell: bash
        run: |
          # ä½¿ç”¨ node è„šæœ¬å¿«é€Ÿä¿®æ”¹ tauri.conf.json
          node -e "
            const fs = require('fs');
            const conf = JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json', 'utf8'));
            conf.bundle.windows = conf.bundle.windows || {};
            conf.bundle.windows.nsis = { 
              installMode: 'portable', 
              languages: ['zh-CN'],
              displayLanguageSelector: false 
            };
            fs.writeFileSync('src-tauri/tauri.conf.json', JSON.stringify(conf, null, 2));
          "

      # 6. æ„å»ºå¹¶å‘å¸ƒ
      - name: build and release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }} # ä½¿ç”¨å½“å‰æ¨é€åˆ°æ ‡ç­¾å
          releaseName: "SafeMask v__VERSION__" # ç‰ˆæœ¬å·ä¼šè‡ªåŠ¨ä» tauri.conf.json æå–
          releaseBody: "ğŸš€ SafeMask æè‡´æ€§èƒ½è„±æ•å·¥å…·æ–°ç‰ˆæœ¬å‘å¸ƒã€‚è¯¦æƒ…è¯·è§ä¸‹æ–¹é™„ä»¶ã€‚"
          releaseDraft: true # å…ˆä½œä¸ºè‰ç¨¿å‘å¸ƒï¼Œç¡®è®¤æ— è¯¯åå†æ‰‹åŠ¨ç‚¹å‡»å…¬å¼€
          prerelease: false
          args: ${{ matrix.args }}

       # ğŸš€ é™„åŠ æ­¥éª¤ï¼šé’ˆå¯¹ Windows é¢å¤–æ‰“åŒ…ä¸€ä¸ªçœŸæ­£çš„ ZIP ç»¿è‰²ç‰ˆ
      - name: Package Windows ZIP Portable
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          $VERSION = "${{ github.ref_name }}".Replace("v", "")
          $ReleaseDir = "src-tauri/target/release"
          $PortableDir = "SafeMask_$VERSION`_Portable_Win64"
          
          # åˆ›å»ºæ‰“åŒ…ç›®å½•
          New-Item -ItemType Directory -Path $PortableDir
          
          # æ‹·è´äºŒè¿›åˆ¶æ–‡ä»¶
          Copy-Item "$ReleaseDir/SafeMask.exe" -Destination "$PortableDir/"
          
          # æ‹·è´èµ„æºæ–‡ä»¶å¤¹ (Tauri v2 ç¼–è¯‘åçš„èµ„æºé€šå¸¸åœ¨ resources ç›®å½•ä¸‹)
          if (Test-Path "$ReleaseDir/resources") {
              Copy-Item -Recurse "$ReleaseDir/resources" -Destination "$PortableDir/"
          }
          
          # å‹ç¼©
          Compress-Archive -Path "$PortableDir/*" -DestinationPath "$PortableDir.zip"
          
          # å°† ZIP ä½œä¸ºèµ„äº§ä¸Šä¼ åˆ°åŒä¸€ä¸ª Release
          gh release upload ${{ github.ref_name }} "$PortableDir.zip" --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}