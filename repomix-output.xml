This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
æµ‹è¯•æ–¹å¼.md
Cargo.toml
command-win.txt
LICENSE
README.md
release.md
rules/auth/ai/keys.yaml
rules/auth/database/urls.yaml
rules/network/dns.yaml
rules/network/ip.yaml
rules/personal/cardNum.yaml
rules/personal/email.yaml
rules/personal/phone.yaml
rules/rulesTemp.md
src/config.rs
src/engine.rs
src/main.rs
test_func.txt
test_perf.txt
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="æµ‹è¯•æ–¹å¼.md">
ä¸ºäº†çœŸæ­£å‹æµ‹ **`safemask`** çš„ **Mmapï¼ˆå†…å­˜æ˜ å°„ï¼‰** å’Œ **Rayonï¼ˆå¤šæ ¸å¹¶è¡Œï¼‰** ç‰¹æ€§ï¼Œæˆ‘ä»¬éœ€è¦æŠŠæ•°æ®é‡æå‡åˆ° **GB çº§åˆ«ï¼ˆä¾‹å¦‚ 5GB - 10GBï¼‰**ã€‚

åœ¨ Windows PowerShell ä¸­ï¼Œé«˜æ•ˆç”Ÿæˆå¤§æ–‡ä»¶æœ‰ä¸¤ç§æ¨èæ–¹æ¡ˆï¼š

---

### æ–¹æ¡ˆä¸€ï¼šå€å¢æ³•ï¼ˆæœ€å¿«ï¼Œåˆ©ç”¨ç°æœ‰æ–‡ä»¶ï¼‰
å¦‚æœä½ å·²ç»ç”Ÿæˆäº†é‚£ä¸ª 200MB çš„ `test_perf.log`ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ–‡ä»¶æµç›´æ¥æŠŠå®ƒå¿«é€Ÿå¤åˆ¶å¹¶åˆå¹¶ï¼Œå®ç°å®¹é‡ç¿»å€ã€‚

**åœ¨ PowerShell ä¸­è¿è¡Œä»¥ä¸‹ä»£ç ï¼š**

```powershell
# å°† 200MB çš„æ–‡ä»¶è‡ªæˆ‘å¤åˆ¶åˆå¹¶ï¼Œè¿è¡Œ 5 æ¬¡å°±æ˜¯ 32 å€ (çº¦ 6.4GB)
$source = "test_perf.log"
$target = "test_big_5gb.log"

Write-Host "ğŸš€ æ­£åœ¨é€šè¿‡å€å¢æ³•ç”Ÿæˆå¤§æ–‡ä»¶..." -ForegroundColor Cyan

# å…ˆæ‹·è´ä¸€ä»½ä½œä¸ºåŸºç¡€
Copy-Item $source $target

# å¾ªç¯ 5 æ¬¡ï¼Œæ¯æ¬¡æ–‡ä»¶å¤§å°ç¿»å€ï¼š200MB -> 400 -> 800 -> 1.6G -> 3.2G -> 6.4G
for ($i = 1; $i -le 5; $i++) {
    Write-Host "æ­£åœ¨è¿›è¡Œç¬¬ $i æ¬¡ç¿»å€..."
    # ä½¿ç”¨ CMD çš„äºŒè¿›åˆ¶æ‹·è´æ¨¡å¼ï¼Œè¿™æ˜¯ Windows ä¸‹åˆå¹¶æ–‡ä»¶æœ€å¿«çš„æ–¹å¼
    cmd /c "copy /b $target + $target $target_tmp"
    Move-Item $target_tmp $target -Force
}

Write-Host "âœ… æˆåŠŸç”Ÿæˆè¶…å¤§æµ‹è¯•æ–‡ä»¶: $target" -ForegroundColor Green
```

---

### æ–¹æ¡ˆäºŒï¼šé«˜æ€§èƒ½ .NET æµç”Ÿæˆå™¨ï¼ˆç”Ÿæˆ 1000 ä¸‡è¡Œ â‰ˆ 2.7GBï¼‰
å¦‚æœä½ æƒ³ç”Ÿæˆæ›´å…·éšæœºæ€§çš„æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå¾ªç¯æ¬¡æ•°åŠ å¤§ã€‚ä¸ºäº†é¿å… PowerShell è‡ªèº«çš„æ€§èƒ½ç“¶é¢ˆï¼Œæˆ‘ä»¬å¢å¤§ç¼“å†²åŒºã€‚

```powershell
$path = "test_perf_1000.log"
$lines = 10000000  # 1000 ä¸‡è¡Œ

# 1. åˆå§‹åŒ–éšæœºæ•°å‘ç”Ÿå™¨å®ä¾‹ (ä¿®å¤æŠ¥é”™çš„å…³é”®)
$rand = [System.Random]::new()

# 2. å®šä¹‰ç¼ºå¤±çš„å˜é‡åº“
$domains = @("internal.cloud", "prod.corp", "dev.local", "secure.node", "api.service.io")
$phonePrefixes = @("138", "139", "150", "159", "170", "188", "133", "189", "131")

Write-Host "ğŸš€ æ­£åœ¨ç”Ÿæˆ 1000 ä¸‡è¡Œå‹åŠ›æµ‹è¯•æ•°æ®..." -ForegroundColor Cyan

# 3. ä½¿ç”¨ 64KB ç¼“å†²åŒºä»¥æå‡å†™å…¥é€Ÿåº¦
$sw = [System.IO.StreamWriter]::new((Join-Path (Get-Location) $path), $false, [System.Text.Encoding]::UTF8, 65536)

for ($i = 1; $i -le $lines; $i++) {
    # 4. æ­£ç¡®è°ƒç”¨éšæœºæ•°å®ä¾‹æ–¹æ³• .Next()
    $ip = "$($rand.Next(1,255)).$($rand.Next(0,255)).$($rand.Next(0,255)).$($rand.Next(0,255))"
    
    # éšæœºé€‰æ‹©å‰ç¼€å¹¶ç”Ÿæˆæ‰‹æœºå·
    $prefix = $phonePrefixes[$rand.Next(0, $phonePrefixes.Length)]
    $phone = "$prefix$($rand.Next(10000000, 99999999))"
    
    # ç”Ÿæˆ UUID ç›¸å…³çš„éšæœºæ•°æ®
    $guid = [guid]::NewGuid().ToString()
    $email = "user_$($guid.Substring(0,8))@$($domains[$rand.Next(0, $domains.Length)])"
    $dns = "node-$($rand.Next(100,999)).$($domains[$rand.Next(0, $domains.Length)])"
    
    $db_uri = "postgres://admin:pwd$($rand.Next(1000,9999))@$dns:5432/db_main"
    
    # æ„é€ ä¸€è¡Œæ··åˆæ—¥å¿—
    $line = "INFO [2026-01-09] REQ_ID:$guid | Client: $ip | Phone: $phone | Email: $email | DNS: $dns | DB: $db_uri | Key: sk-$($guid)$($guid)"
    
    $sw.WriteLine($line)
    
    # æ¯ 100 ä¸‡è¡ŒæŠ¥å‘Šä¸€æ¬¡è¿›åº¦
    if ($i % 1000000 -eq 0) { 
        $percent = ($i / $lines) * 100
        Write-Host "å·²å®Œæˆ $percent% ..." 
    }
}

$sw.Close()
Write-Host "âœ… å‹åŠ›æµ‹è¯•æ–‡ä»¶ $path ç”Ÿæˆå®Œæ¯• (çº¦ 1.8GB - 2.2GB)" -ForegroundColor Green
```


### .NET æµç”Ÿæˆå™¨ï¼ˆç”Ÿæˆ 100 ä¸‡è¡Œ â‰ˆ 280MBï¼‰
```powershell
$path = "test_perf_100.log"
$lines = 1000000  # 1000 ä¸‡è¡Œ

# 1. åˆå§‹åŒ–éšæœºæ•°å‘ç”Ÿå™¨å®ä¾‹ (ä¿®å¤æŠ¥é”™çš„å…³é”®)
$rand = [System.Random]::new()

# 2. å®šä¹‰ç¼ºå¤±çš„å˜é‡åº“
$domains = @("internal.cloud", "prod.corp", "dev.local", "secure.node", "api.service.io")
$phonePrefixes = @("138", "139", "150", "159", "170", "188", "133", "189", "131")

Write-Host "ğŸš€ æ­£åœ¨ç”Ÿæˆ 100 ä¸‡è¡Œå‹åŠ›æµ‹è¯•æ•°æ®..." -ForegroundColor Cyan

# 3. ä½¿ç”¨ 64KB ç¼“å†²åŒºä»¥æå‡å†™å…¥é€Ÿåº¦
$sw = [System.IO.StreamWriter]::new((Join-Path (Get-Location) $path), $false, [System.Text.Encoding]::UTF8, 65536)

for ($i = 1; $i -le $lines; $i++) {
    # 4. æ­£ç¡®è°ƒç”¨éšæœºæ•°å®ä¾‹æ–¹æ³• .Next()
    $ip = "$($rand.Next(1,255)).$($rand.Next(0,255)).$($rand.Next(0,255)).$($rand.Next(0,255))"
    
    # éšæœºé€‰æ‹©å‰ç¼€å¹¶ç”Ÿæˆæ‰‹æœºå·
    $prefix = $phonePrefixes[$rand.Next(0, $phonePrefixes.Length)]
    $phone = "$prefix$($rand.Next(10000000, 99999999))"
    
    # ç”Ÿæˆ UUID ç›¸å…³çš„éšæœºæ•°æ®
    $guid = [guid]::NewGuid().ToString()
    $email = "user_$($guid.Substring(0,8))@$($domains[$rand.Next(0, $domains.Length)])"
    $dns = "node-$($rand.Next(100,999)).$($domains[$rand.Next(0, $domains.Length)])"
    
    $db_uri = "postgres://admin:pwd$($rand.Next(1000,9999))@$dns:5432/db_main"
    
    # æ„é€ ä¸€è¡Œæ··åˆæ—¥å¿—
    $line = "INFO [2026-01-09] REQ_ID:$guid | Client: $ip | Phone: $phone | Email: $email | DNS: $dns | DB: $db_uri | Key: sk-$($guid)$($guid)"
    
    $sw.WriteLine($line)
    
    # æ¯ 10 ä¸‡è¡ŒæŠ¥å‘Šä¸€æ¬¡è¿›åº¦
    if ($i % 100000 -eq 0) { 
        $percent = ($i / $lines) * 100
        Write-Host "å·²å®Œæˆ $percent% ..." 
    }
}

$sw.Close()
Write-Host "âœ… å‹åŠ›æµ‹è¯•æ–‡ä»¶ $path ç”Ÿæˆå®Œæ¯• " -ForegroundColor Green

```

---

### å¦‚ä½•è¿›è¡ŒçœŸæ­£çš„æ€§èƒ½å‹æµ‹ï¼Ÿ

å½“ä½ æ‹¥æœ‰äº†ä¸€ä¸ª **5GB ä»¥ä¸Š** çš„æ–‡ä»¶åï¼Œä½ å¯ä»¥è§‚å¯Ÿåˆ° `safemask` æå…¶ç¡¬æ ¸çš„è¡¨ç°ï¼š

#### 1. ç›‘æ§ç£ç›˜ I/O
è¿è¡Œæµ‹è¯•ï¼š
```powershell
# è®°å¾—æŠŠæ§åˆ¶å°ç¼–ç è®¾ä¸º UTF8 é¿å…è¾“å‡ºä¹±ç å¹²æ‰°
chcp 65001
Measure-Command { ./target/release/safemask --mode file --path test_big_5gb.log > output_big.txt }
```

#### 2. è§‚å¯Ÿä»»åŠ¡ç®¡ç†å™¨
åœ¨ç¨‹åºè¿è¡Œçš„é‚£å‡ ç§’é’Ÿï¼š
*   **CPU**ï¼šç‚¹å‡»â€œé€»è¾‘å¤„ç†å™¨â€è§†å›¾ï¼Œä½ åº”è¯¥çœ‹åˆ°**æ‰€æœ‰æ ¸å¿ƒ**å…¨éƒ¨ç¬é—´é¡¶æ»¡ã€‚è¿™è¯æ˜ `Rayon` çš„å·¥ä½œçªƒå–ï¼ˆWork-stealingï¼‰ç®—æ³•æ­£åœ¨ç–¯ç‹‚å‹æ¦¨å¤šæ ¸æ€§èƒ½ã€‚
*   **å†…å­˜**ï¼šé‡ç‚¹æ¥äº†ï¼è§‚å¯Ÿ `safemask` çš„å†…å­˜å ç”¨ã€‚ä½ ä¼šå‘ç°ï¼Œè™½ç„¶ä½ å¤„ç†çš„æ˜¯ 5GB çš„æ–‡ä»¶ï¼Œä½† **`safemask` çš„å†…å­˜å ç”¨ï¼ˆPrivate Bytesï¼‰å¯èƒ½éå¸¸ä½**ã€‚
    *   **åŸå› **ï¼šè¿™å°±æ˜¯ `Mmap` çš„é­”åŠ›ã€‚å®ƒæ²¡æœ‰æŠŠ 5GB å…¨éƒ¨è¯»è¿›å†…å­˜ï¼Œè€Œæ˜¯è®©æ“ä½œç³»ç»ŸæŒ‰éœ€æ˜ å°„ç£ç›˜åˆ†é¡µã€‚è¿™è¯æ˜äº†ä½ çš„ç¨‹åºå…·å¤‡å¤„ç†â€œè¶…å¤§æ•°æ®é‡â€ï¼ˆè¶…è¿‡ç‰©ç†å†…å­˜å®¹é‡ï¼‰çš„èƒ½åŠ›ã€‚

#### 3. ç»“æœéªŒè¯
å¤„ç†å®Œå¤§æ–‡ä»¶åï¼ŒéšæœºæŠ½æŸ¥æœ€åå‡ è¡Œï¼š
```powershell
# 1. æ–‡ä»¶æœ€å‰é¢ 7 è¡Œ
Write-Host "=== æ–‡ä»¶å¼€å¤´ (å‰ 7 è¡Œ) ===" -ForegroundColor Cyan
Get-Content output_big.txt -First 7

# 2. æ–‡ä»¶æœ€å 7 è¡Œ
Write-Host "`n=== æ–‡ä»¶ç»“å°¾ (å 7 è¡Œ) ===" -ForegroundColor Cyan
Get-Content output_big.txt -Tail 7

# 3. éšæœºæŠ½ 6 è¡Œï¼ˆæ•ˆæœæ¯”è¾ƒå¥½ï¼‰, å¤§æ–‡ä»¶ä¸å»ºè®®ä½¿ç”¨, è€—æ—¶è¾ƒé•¿
Write-Host "`n=== æ–‡ä»¶ä¸­éšæœº 6 è¡Œ ===" -ForegroundColor Cyan
Get-Content output_big.txt | Get-Random -Count 6
```
</file>

<file path="command-win.txt">
$start = Get-Date
Write-Host "ğŸš€ å¼€å§‹è„±æ•å¤„ç†: $start" -ForegroundColor Cyan

./target/release/safemask --mode file --path test_perf.log > output.txt

$end = Get-Date
$duration = $end - $start
Write-Host "âœ… å¤„ç†å®Œæˆ: $end" -ForegroundColor Green
Write-Host "â±ï¸ æ€»å…±è€—æ—¶: $($duration.TotalSeconds) ç§’" -ForegroundColor Yellow
</file>

<file path="LICENSE">
MIT License

Copyright (c) 2026 xiao sheng

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
</file>

<file path="release.md">
å¯¹äºä¸€ä¸ª 5 å¹´ç»éªŒã€è¿½æ±‚é«˜è´¨é‡äº§å‡ºçš„å·¥ç¨‹å¸ˆæ¥è¯´ï¼ŒGitHub Release ä¸ä»…ä»…æ˜¯ä¸Šä¼ ä¸€ä¸ª `.exe` æ–‡ä»¶ï¼Œå®ƒæ˜¯ä¸€ä»½**äº§å“çš„èº«ä»½è¯´æ˜ä¹¦**ã€‚

ä»¥ä¸‹æ˜¯ä¸ºä½ è®¾è®¡çš„ **SafeMask v0.1.0** å‘å¸ƒè¯´æ˜æ¨¡æ¿ã€‚ä½ å¯ä»¥ç›´æ¥å¤åˆ¶åˆ° GitHub çš„ "Release Notes" æ¡†ä¸­ï¼Œå¹¶æ ¹æ®å®é™…æƒ…å†µå¾®è°ƒã€‚

---

## ğŸš€ SafeMask v0.4.1 - High Performance Privacy Guard



### ğŸŒŸ æ ¸å¿ƒç‰¹æ€§ (Key Features)

*   **æè‡´æ€§èƒ½å¼•æ“**ï¼šé‡‡ç”¨ **Aho-Corasick** ç®—æ³•ä¸ **è¶…çº§æ­£åˆ™ (Combined DFA)** æ··åˆé©±åŠ¨ï¼Œå®ç°å•æ¬¡æ‰«æè„±æ•ã€‚
*   **é›¶æ‹·è´ I/O**ï¼šæ·±åº¦åˆ©ç”¨ **Memory Mapping (Mmap)** æŠ€æœ¯ï¼Œå¤„ç† GB çº§åˆ«å¤§æ–‡ä»¶æ—¶å†…å­˜å ç”¨æä½ã€‚
*   **å¤šæ ¸å¹¶å‘å¤„ç†**ï¼šé€šè¿‡ **Rayon** å¹¶è¡Œæµï¼Œè‡ªåŠ¨åˆ©ç”¨å¤šæ ¸ CPU ç®—åŠ›ï¼Œ100MB çº§åˆ«æ—¥å¿—å¤„ç†ä»…éœ€ **0.4s**ã€‚
*   **æ¨¡å—åŒ–é…ç½®**ï¼šæ”¯æŒ YAML å®šä¹‰è§„åˆ™åŒ…ï¼Œæ¶µç›– OpenAI/Claude/DeepSeek API Keysã€ä¸»æµæ•°æ®åº“è¿æ¥ä¸²ã€IP/Email ç­‰ã€‚
*   **åŒæ¨¡å¼æ”¯æŒ**ï¼š
    *   **Clipboard æ¨¡å¼**ï¼šä¸€é”®å¤„ç†å‰ªè´´æ¿å†…å®¹ï¼Œæ— ç¼å¯¹æ¥ ChatGPT/Claude å¯¹è¯ã€‚
    *   **File æ¨¡å¼**ï¼šæ”¯æŒå¤§è§„æ¨¡æœ¬åœ°æ—¥å¿—æ–‡ä»¶çš„è„±æ•å¯¼å‡ºã€‚

### ğŸ“Š æ€§èƒ½è¡¨ç° (Benchmarks)

åœ¨ Windows 11 ç¯å¢ƒä¸‹ï¼Œå¤„ç†åŒ…å«ç™¾ä¸‡è¡Œæ•°æ®çš„çœŸå®æ—¥å¿—æ–‡ä»¶ï¼ˆ113 MBï¼‰ï¼š
*   **ååé‡**: ~270 MB/s
*   **æ€»è€—æ—¶**: **420ms** (è®¡ç®—+ç£ç›˜å†™å…¥)
*   **å†…å­˜å³°å€¼**: < 50 MB

### ğŸ“‚ äº§ç‰©è¯´æ˜ (Artifacts)

| æ–‡ä»¶å | é€‚ç”¨å¹³å° | è¯´æ˜ |
| :--- | :--- | :--- |
| `safemask-v0.1.0-windows-x64.zip` | Windows 10/11 | åŒ…å«å¯æ‰§è¡Œæ–‡ä»¶åŠç¤ºä¾‹è§„åˆ™æ–‡ä»¶å¤¹ |
| `rules.zip` | å…¨å¹³å° | é¢„ç½®çš„è„±æ•è§„åˆ™åŒ…ï¼ˆAI, Database, Networkï¼‰ |

### ğŸ› ï¸ å®‰è£…ä¸ä½¿ç”¨ (Quick Start)

1.  ä¸‹è½½å¹¶è§£å‹ `safemask-v0.1.0-windows-x64.zip`ã€‚
2.  ç¡®ä¿ `safemask.exe` åŒçº§ç›®å½•ä¸‹å­˜åœ¨ `rules/` æ–‡ä»¶å¤¹ã€‚
3.  **å‰ªè´´æ¿è„±æ•**ï¼š
    ```powershell
    ./safemask --mode clipboard
    ```
4.  **å¤§è§„æ¨¡æ–‡ä»¶å¤„ç†**ï¼š
    ```powershell
    ./safemask --mode file --path test.log --output masked.log
    ```

### ğŸ”’ å®‰å…¨æ‰¿è¯º

*   **100% ç¦»çº¿è¿è¡Œ**ï¼šæ‰€æœ‰è®¡ç®—å‡åœ¨æœ¬åœ°å®Œæˆï¼Œç»ä¸ä¸Šä¼ ä»»ä½•æ•°æ®ã€‚
*   **å¼€æºé€æ˜**ï¼šæ ¸å¿ƒç®—æ³•é€»è¾‘å®Œå…¨é€æ˜ï¼Œæ¥å—ç¤¾åŒºå®¡è®¡ã€‚

---

### ğŸ’¡ å‘å¸ƒå‰çš„å°å»ºè®® (Checklist)

1.  **æ‰“åŒ…è§„åˆ™æ–‡ä»¶å¤¹**ï¼š
    ç”±äºä½ çš„ç¨‹åºä¾èµ– `rules/` ç›®å½•ä¸‹çš„ YAML æ–‡ä»¶ï¼Œç”¨æˆ·ä¸‹è½½åå¦‚æœæ²¡æœ‰è¿™ä¸ªç›®å½•ä¼šæŠ¥é”™ã€‚
    *   **å»ºè®®**ï¼šå°† `safemask.exe` å’Œ `rules/` æ–‡ä»¶å¤¹ä¸€èµ·æ‰“åŒ…è¿›ä¸€ä¸ª `.zip` æ–‡ä»¶ã€‚
2.  **é™æ€é“¾æ¥ (Static Linking)**ï¼š
    ä¸ºäº†é˜²æ­¢ç”¨æˆ·ç”µè„‘ç¼ºå°‘æŸäº› DLLï¼Œå»ºè®®åœ¨ Windows ç¼–è¯‘æ—¶ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼ˆå¦‚æœæ˜¯ç”¨ MSVC ç¯å¢ƒï¼‰ï¼š
    ```powershell
    # è¿™æ ·ç”Ÿæˆçš„ .exe å°±ä¸ä¾èµ–ç‰¹å®šçš„ VC è¿è¡Œæ—¶åº“
    $env:RUSTFLAGS="-C target-feature=+crt-static"
    cargo build --release
    ```
3.  **è®¡ç®— Hash å€¼**ï¼ˆä¸“ä¸šä½“ç°ï¼‰ï¼š
    åœ¨ Release è¯´æ˜çš„æœ«å°¾ï¼Œæ”¾ä¸ŠäºŒè¿›åˆ¶æ–‡ä»¶çš„ SHA256 æ ¡éªŒç ï¼Œé˜²æ­¢æ–‡ä»¶è¢«ç¯¡æ”¹ï¼š
    ```powershell
    # Windows ä¸‹è·å–å“ˆå¸Œå€¼
    Get-FileHash ./target/release/safemask.exe -Algorithm SHA256
    ```
4.  **LICENSE æ–‡ä»¶**ï¼š
    ç¡®ä¿ä»“åº“é‡Œæœ‰ä¸€ä¸ª `LICENSE` æ–‡ä»¶ï¼ˆæ¨è MIT æˆ– Apache 2.0ï¼‰ï¼Œè¿™å¯¹è¿œç¨‹å·¥ä½œçš„åˆè§„æ€§åŠ åˆ†å¾ˆé‡è¦ã€‚

è¿™ä»½è¯´æ˜ä½“ç°äº†ä½ ä½œä¸ºä¸€ä¸ª**èµ„æ·±åç«¯å·¥ç¨‹å¸ˆ**å¯¹æ€§èƒ½ã€æ˜“ç”¨æ€§å’Œå®‰å…¨æ€§çš„å…¨é¢è€ƒè™‘ã€‚å‘å¸ƒåï¼Œè¿™ä¸ä»…æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œæ›´æ˜¯ä½  Rust å·¥ç¨‹èƒ½åŠ›çš„æœ‰åŠ›è¯è¨€ã€‚
</file>

<file path="rules/auth/ai/keys.yaml">
group: "SENSITIVE_INFO"
rules:
  # --- AI API KEYS (å»æ‰äº†é”šç‚¹ï¼Œå¢åŠ äº†è¾¹ç•Œåˆ¤å®š) ---
  - name: "OpenAI"
    pattern: '\bsk-[a-zA-Z0-9]{48,}\b' # é€‚é… sk-proj åŠé•¿ key
    mask: "<OPENAI_KEY>"
    priority: 10 # é«˜ä¼˜å…ˆçº§
  
  - name: "Anthropic_Claude"
    pattern: '\bsk-ant-api03-[a-zA-Z0-9\-_]{90,100}AA\b'
    mask: "<CLAUDE_KEY>"
    priority: 10 # é«˜ä¼˜å…ˆçº§

  - name: "Google_Gemini"
    pattern: '\bAIzaSy[a-zA-Z0-9\-_]{33}\b'
    mask: "<GEMINI_KEY>"
    priority: 10 # é«˜ä¼˜å…ˆçº§

  - name: "DeepSeek"
    pattern: '\bsk-[a-z0-9]{32}\b'
    mask: "<DEEPSEEK_KEY>"
    priority: 10 # é«˜ä¼˜å…ˆçº§
</file>

<file path="rules/auth/database/urls.yaml">
group: "DATABASE_CONNECTION"
rules:
  - name: "PostgreSQL_URI"
    # ç§»é™¤äº† ^ å’Œ $ï¼Œä½¿ç”¨ \b (è¯è¾¹ç•Œ) å¹¶åœ¨æœ«å°¾ä½¿ç”¨æ’é™¤å­—ç¬¦é›†ï¼Œç¡®ä¿æŠ“å–åˆ°ç©ºç™½ç¬¦æˆ–å¼•å·ä¸ºæ­¢
    pattern: '\bpostgres(?:ql)?://[^\s''"<>]+'
    mask: "<POSTGRES_URI>"

  - name: "MySQL_URI"
    pattern: '\bmysql(?:\+.+)?://[^\s''"<>]+'
    mask: "<MYSQL_URI>"

  - name: "MongoDB_URI"
    pattern: '\bmongodb(?:\+srv)?://[^\s''"<>]+'
    mask: "<MONGODB_URI>"

  - name: "Redis_URI"
    pattern: '\brediss?://[^\s''"<>]+'
    mask: "<REDIS_URI>"

  - name: "SQLServer_URI"
    pattern: '\bsqlserver://[^\s''"<>]+'
    mask: "<SQLSERVER_URI>"

  - name: "Oracle_URI"
    pattern: '\boracle:thin:@[^\s''"<>]+'
    mask: "<ORACLE_URI>"

  - name: "SQLite_File"
    pattern: '\bsqlite(?:3)?://[^\s''"<>]+'
    mask: "<SQLITE_URI>"
</file>

<file path="rules/network/dns.yaml">
group: "SENSITIVE_INFO"
rules:
  - name: "FQDN_Domain"
    pattern: '\b[a-zA-Z](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*\.[a-zA-Z]{2,}\b'
    mask: "<DOMAIN>"
    priority: 5 # æ™®é€šä¼˜å…ˆçº§
</file>

<file path="rules/personal/cardNum.yaml">
group: "SENSITIVE_INFO"
rules:
  - name: "China_ID_Card_18"
  # èº«ä»½è¯æœ«å°¾å¯èƒ½æ˜¯ Xï¼Œå‰åå¿…é¡»æ˜¯è¯è¾¹ç•Œé˜²æ­¢è¯¯åˆ‡é•¿æ•°å­—
    pattern: '\b[1-9]\d{5}(19|20)\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])\d{3}(\d|X|x)\b'
    mask: "<CHINA_ID_CARD>"
    priority: 100 # æ›´é«˜ä¼˜å…ˆçº§
</file>

<file path="rules/personal/phone.yaml">
group: "SENSITIVE_INFO"
rules:
  - name: "Global_Phone_E164"
    pattern: '\b[1-9]\d{7,14}\b'
    mask: "<GLOBAL_PHONE>"
    priority: 5 # ä½ä¼˜å…ˆçº§

  - name: "China_Mobile_Phone"
    # å¢åŠ äº†è¾¹ç•Œåˆ¤å®šï¼Œé˜²æ­¢åŒ¹é…åˆ°æ—¶é—´æˆ³ä¸­çš„ä¸€æ®µæ•°å­—
    pattern: '\b1[3-9]\d{9}\b'
    mask: "<CHINA_MOBILE>"
    priority: 100 # æ›´é«˜ä¼˜å…ˆçº§
</file>

<file path="rules/rulesTemp.md">
ä¸ºäº†ä¿è¯ safemask çš„æè‡´æ€§èƒ½å’ŒåŒ¹é…å‡†ç¡®æ€§ï¼Œè¯·éµå¾ªä»¥ä¸‹è§„èŒƒï¼š
1. æ­£åˆ™ç¼–å†™å‡†åˆ™ (Principles)
è„±æ•è€Œéæ ¡éªŒï¼šæˆ‘ä»¬çš„ç›®çš„æ˜¯é®ç›–éšç§ï¼Œä¸æ˜¯éªŒè¯æ•°æ®çš„åˆæ³•æ€§ã€‚å®å¯é”™æ€ï¼ˆé®ç›–èŒƒå›´ç¨å¤§ï¼‰ï¼Œä¸å¯æ¼è¿‡ã€‚ å¤æ‚çš„æ­£åˆ™ï¼ˆå¦‚ä¸¥æ ¼çš„ Email æ ¡éªŒï¼‰ä¼šæ˜¾è‘—é™ä½åŒ¹é…é€Ÿåº¦ã€‚
è¯è¾¹ç•Œä¼˜å…ˆï¼šå§‹ç»ˆåœ¨æ­£åˆ™ä¸¤ç«¯ä½¿ç”¨ \bã€‚è¿™èƒ½é˜²æ­¢æŠŠ ID_12345678901 ä¸­çš„æ•°å­—è¯¯è®¤ä¸ºæ‰‹æœºå·ã€‚
ç¦ç”¨é”šç‚¹ï¼šä¸¥ç¦åœ¨ rules ä¸­ä½¿ç”¨ ^ å’Œ $ï¼ˆé™¤éä½ ç¡®å®šè¦åŒ¹é…æ•´è¡Œï¼‰ã€‚
ç¦æ­¢ç¯è§†ï¼šRust regex åº“ä¸æ”¯æŒ (?!)ã€(?<=) ç­‰ã€‚å¦‚æœéœ€è¦æ’é™¤ï¼Œè¯·é€šè¿‡å­—ç¬¦é›† [^...] å®ç°ã€‚

group: "CATEGORY_NAME" # å¤§ç±»åç§°ï¼ˆå¦‚ AUTH, PII, NETWORKï¼‰
rules:
  - name: "Rule_Unique_Name" # è§„åˆ™æè¿°å
    # æ¨¡å¼å»ºè®®ï¼š
    # 1. ä½¿ç”¨å•å¼•å·åŒ…è£¹ï¼Œé˜²æ­¢ YAML è½¬ä¹‰å†²çª
    # 2. æ¨¡å¼å¼€å¤´ç»“å°¾å°½é‡ä½¿ç”¨ \b
    # 3. é¿å…è¿‡åº¦ä½¿ç”¨ (.*) ç­‰è´ªå©ªåŒ¹é…
    pattern: '\bPREFIX-[a-zA-Z0-9]{10,}\b'
    mask: "<LABEL>" # å»ºè®®ä½¿ç”¨å¤§å†™+å°–æ‹¬å·ï¼ŒAI è¯†åˆ«æ•ˆæœæœ€å¥½
</file>

<file path="src/config.rs">
use serde::Deserialize;
use std::path::Path;
use walkdir::WalkDir;

#[derive(Debug, Deserialize, Clone)]
pub struct Rule {
    #[allow(dead_code)]
    pub name: String,
    pub pattern: String,
    pub mask: String,
    #[serde(default = "default_priority")] // å¦‚æœYAMLæ²¡å†™ä¼˜å…ˆçº§ï¼Œåˆ™é»˜è®¤ä¸º0
    pub priority: i32,
}

fn default_priority() -> i32 { 0 }

#[derive(Debug, Deserialize, Clone)]
pub struct RuleGroup {
    #[allow(dead_code)]
    pub group: String,
    pub rules: Vec<Rule>,
}

/// é€’å½’æ‰«æç›®å½•åŠ è½½æ‰€æœ‰ YAML è§„åˆ™
pub fn load_all_rules<P: AsRef<Path>>(dir: P) -> Vec<Rule> {
    let mut all_rules = Vec::new();
    for entry in WalkDir::new(dir).into_iter().filter_map(|e| e.ok()) {
        let path = entry.path();
        if path.is_file() && path.extension().map_or(false, |ext| ext == "yaml") {
            let content = std::fs::read_to_string(path).expect("æ— æ³•è¯»å–è§„åˆ™æ–‡ä»¶");
            if let Ok(group) = serde_yaml::from_str::<RuleGroup>(&content) {
                all_rules.extend(group.rules);
            }
        }
    }
    all_rules
}
</file>

<file path="test_perf.txt">
$path = "test_perf.log"
$lines = 1000000

Write-Host "ğŸš€ æ­£åœ¨ç”Ÿæˆ 100 ä¸‡è¡Œæµ‹è¯•æ•°æ®..." -ForegroundColor Cyan

# 1. å…ˆåˆ›å»ºä¸€ä¸ªéšæœºæ•°å®ä¾‹ (è¿™æ˜¯ä¿®å¤æŠ¥é”™çš„å…³é”®)
$rand = New-Object System.Random

# 2. ä½¿ç”¨ .NET çš„ StreamWriter
$filePath = Join-Path (Get-Location) $path
$sw = [System.IO.StreamWriter]::new($filePath)

for ($i = 1; $i -le $lines; $i++) {
    # 3. ä½¿ç”¨å®ä¾‹æ–¹æ³•è°ƒç”¨ .Next()
    $ip = "$($rand.Next(1,255)).$($rand.Next(0,255)).$($rand.Next(0,255)).$($rand.Next(0,255))"
    
    # ç”ŸæˆåŒ…å«å…³é”®è¯å’Œæ­£åˆ™ç‰¹å¾çš„è¡Œ
    $guid1 = [guid]::NewGuid().ToString("N")
    $line = "INFO [2026-01-09] User_$i (IP: $ip) accessed TopSecretProject using sk-$guid1"
    
    $sw.WriteLine($line)
    
    if ($i % 200000 -eq 0) { Write-Host "è¿›åº¦: å·²å®Œæˆ $i è¡Œ..." }
}

$sw.Close()
Write-Host "âœ… æˆåŠŸç”Ÿæˆæ–‡ä»¶: $path" -ForegroundColor Green
</file>

<file path="rules/network/ip.yaml">
group: "SENSITIVE_INFO"
rules:
  - name: "IPv4_Address"
    # å…¼é¡¾å‡†ç¡®æ€§ä¸æ€§èƒ½çš„å†™æ³•
    pattern: '\b(?:(?:25[0-5]|2[0-4]\d|1?\d{1,2})\.){3}(?:25[0-5]|2[0-4]\d|1?\d{1,2})\b'
    priority: 60 # é«˜ä¼˜å…ˆçº§

  - name: "IPv6_Address"
    pattern: '\b(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}\b|\b(?:[0-9a-fA-F]{1,4}:){1,7}:|:[:0-9a-fA-F]{1,7}\b'
    mask: "<IPv6>"
    priority: 10
</file>

<file path="rules/personal/email.yaml">
group: "SENSITIVE_INFO"
rules:
  - name: "Email_Address"
    # ç®€åŒ–äº†é€»è¾‘ï¼Œé‡ç‚¹åœ¨äºåŒ¹é… @ å’ŒåŸŸå
    pattern: '\b[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}\b'
    mask: "<EMAIL>"
    priority: 30 # è¾ƒé«˜ä¼˜å…ˆçº§
</file>

<file path="src/engine.rs">
use crate::config::Rule;
use regex::bytes::{Captures, Regex};
use std::borrow::Cow;
use aho_corasick::{AhoCorasick, MatchKind};

/// è§„åˆ™å±‚çº§ï¼šç”¨äºå­˜å‚¨ç¼–è¯‘åçš„æ­£åˆ™åŠå…¶å¯¹åº”çš„åç§»é‡
struct RegexLayer {
    re: Regex,
    masks: Vec<Vec<u8>>,
    offsets: Vec<usize>,
}

pub struct MaskEngine {
    // å±‚çº§ 1: AC å¼•æ“ (å›ºå®šè¯ï¼Œå¤„ç† O(1) åŒ¹é…)
    ac_engine: Option<AhoCorasick>,
    ac_masks: Vec<Vec<u8>>,

    // å±‚çº§ 2 & 3: ä¼˜å…ˆçº§æ­£åˆ™å¼•æ“
    high_layer: Option<RegexLayer>,
    low_layer: Option<RegexLayer>,
}

impl MaskEngine {
     /// æ„é€ å‡½æ•°ï¼šæ‰§è¡Œè§„åˆ™åˆ†ç±»ã€ä¼˜å…ˆçº§æ’åºã€æ•è·ç»„è®¡ç®—åŠå¼•æ“ç¼–è¯‘
    pub fn new(mut rules: Vec<Rule>) -> Self {
        
        // 1. ä¼˜å…ˆçº§é™åºæ’åºï¼šé«˜ä¼˜å…ˆçº§åœ¨å·¦ä¾§ï¼Œç¬¦åˆæ­£åˆ™å¼•æ“åŒ¹é…åå¥½
        rules.sort_by(|a, b| b.priority.cmp(&a.priority).then_with(|| a.name.cmp(&b.name)));

        let mut ac_p = Vec::new(); let mut ac_m = Vec::new();
        let mut hr_p = Vec::new(); let mut hr_m = Vec::new();
        let mut lr_p = Vec::new(); let mut lr_m = Vec::new();
        
        for rule in rules {
            if is_literal(&rule.pattern) {
                ac_p.push(rule.pattern);
                ac_m.push(rule.mask.as_bytes().to_vec());
            } else if rule.priority > 5 {
                hr_p.push(format!("({})", rule.pattern));
                hr_m.push(rule.mask.as_bytes().to_vec());
            } else {
                lr_p.push(format!("({})", rule.pattern));
                lr_m.push(rule.mask.as_bytes().to_vec());
            }
        }
        
        Self {
            ac_engine: if ac_p.is_empty() { None } else {
                Some(AhoCorasick::builder()
                    .match_kind(MatchKind::LeftmostLongest)
                    .build(ac_p).expect("AC å¼•æ“æ„å»ºå¤±è´¥"))
            },
            ac_masks: ac_m,
            high_layer: Self::compile_layer(hr_p, hr_m),
            low_layer: Self::compile_layer(lr_p, lr_m),
        }
    }

     /// ç¼–è¯‘æ­£åˆ™å±‚ï¼Œå¹¶è®¡ç®—æ¯ä¸ªè§„åˆ™çš„æ•è·ç»„èµ·å§‹ç´¢å¼•
    fn compile_layer(patterns: Vec<String>, masks: Vec<Vec<u8>>) -> Option<RegexLayer> {
        if patterns.is_empty() { return None; }

        let mut offsets = Vec::new();
        let mut current_offset = 1; // 0 æ˜¯æ•´ä¸ªåŒ¹é…é¡¹ï¼Œç¬¬ä¸€ä¸ªè§„åˆ™ä» 1 å¼€å§‹

        for p in &patterns {
            let temp_re = Regex::new(p).expect("æ­£åˆ™è¯­æ³•é”™è¯¯");
            offsets.push(current_offset);
            current_offset += temp_re.captures_len(); // åŠ¨æ€è®¡ç®—è¯¥è§„åˆ™å ç”¨çš„ç»„æ•°é‡
        }

        let combined_re = Regex::new(&patterns.join("|")).expect("è¶…çº§æ­£åˆ™èšåˆå¤±è´¥");

        Some(RegexLayer {
            re: combined_re,
            masks,
            offsets,
        })
    }

    /// æ‰§è¡Œè„±æ•æµç¨‹ï¼šAC -> High Priority Regex -> Low Priority Regex
    pub fn mask_line<'a>(&self, input: &'a [u8]) -> Cow<'a, [u8]> {
        // ç¬¬ä¸€é˜¶æ®µ: AC å¼•æ“
        let mut result = if let Some(ref ac) = self.ac_engine {
            Cow::Owned(ac.replace_all_bytes(input, &self.ac_masks))
        } else {
            Cow::Borrowed(input)
        };

        // ç¬¬äºŒé˜¶æ®µ: é«˜ä¼˜å…ˆçº§æ­£åˆ™
        if let Some(ref layer) = self.high_layer {
            let next = layer.re.replace_all(&result, |caps: &Captures| {
                self.dispatch(layer, caps)
            });
            // å…³é”®ï¼šå¦‚æœå‘ç”Ÿäº†æ›¿æ¢ï¼ˆOwnedï¼‰ï¼Œè½¬ç§»æ‰€æœ‰æƒï¼›å¦åˆ™ä¿æŒåŸæ ·ï¼ˆç»´æŒ 'a ç”Ÿå‘½å‘¨æœŸï¼‰
            result = match next {
                Cow::Owned(v) => Cow::Owned(v),
                Cow::Borrowed(_) => result,
            };
        }

        // ç¬¬ä¸‰é˜¶æ®µ: ä½ä¼˜å…ˆçº§æ­£åˆ™
        if let Some(ref layer) = self.low_layer {
            let next = layer.re.replace_all(&result, |caps: &Captures| {
                self.dispatch(layer, caps)
            });
            result = match next {
                Cow::Owned(v) => Cow::Owned(v),
                Cow::Borrowed(_) => result,
            };
        }
        result
    }

    fn dispatch(&self, layer: &RegexLayer, caps: &Captures) -> Vec<u8> {
        for (i, &offset) in layer.offsets.iter().enumerate() {
            if caps.get(offset).is_some() {
                return layer.masks[i].clone();
            }
        }
        b"<MASKED>".to_vec()
    }  
}

/// ç®€å•çš„è¾…åŠ©å‡½æ•°ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºçº¯æ–‡æœ¬ï¼ˆæ— æ­£åˆ™ç‰¹æ®Šç¬¦å·ï¼‰
fn is_literal(pattern: &str) -> bool {
    let specials = [
        '.', '+', '*', '?', '(', ')', '[', ']', '{', '}', '|', '^', '$', '\\',
    ];
    !pattern.chars().any(|c| specials.contains(&c))
}
</file>

<file path="Cargo.toml">
[package]
name = "SafeMask"
version = "0.4.1"
edition = "2024" # 2024æœ€æ–°ç‰ˆè¯­æ³•è§„èŒƒ
authors = ["xiaosheng <xiaosheng.tech@outlook.com>"]
description = "A high-performance, ordered data masking tool written in Rust."
license = "MIT"
readme = "README.md"
repository = "https://github.com/AiToByte/SafeMask.git"

[dependencies]
aho-corasick = "1.1.4"
anyhow = "1.0.100"
arboard = "3.6.1"
clap = { version = "4.5.54", features = ["derive"] }
memmap2 = "0.9.9"
once_cell = "1.21.3"
rayon = "1.11.0"
regex = "1.12.2"
serde = {version = "1.0", features = ["derive"]}
serde_yaml = "0.9"
walkdir = "2.4" # ç”¨äºé€’å½’éå†ç›®å½•
mimalloc = "0.1" # å¼•å…¥ mimalocæå‡é¢‘ç¹å†…å­˜åˆ†é…æ€§èƒ½
crossbeam-channel = "0.5"

# æè‡´æ€§èƒ½ä¼˜åŒ–é…ç½®: å½“è¿è¡Œ cargo build --release æ—¶ç”Ÿæ•ˆ
[profile.release]
opt-level = 3
lto = true # å¯ç”¨é“¾æ¥æ—¶ä¼˜åŒ–
codegen-units = 1 # å‡å°‘ä»£ç ç”Ÿæˆå•å…ƒä»¥æé«˜ä¼˜åŒ–æ•ˆæœ
panic = "abort" # å‡å°‘äºŒè¿›åˆ¶æ–‡ä»¶å¤§å°
</file>

<file path=".gitignore">
# Generated by Cargo
# will have compiled files and executables
debug
target

# These are backup files generated by rustfmt
**/*.rs.bk

# MSVC Windows builds of rustc generate these, which store debugging information
*.pdb

# Generated by cargo mutants
# Contains mutation testing data
**/mutants.out*/

# RustRover
#  JetBrains specific template is maintained in a separate JetBrains.gitignore that can
#  be found at https://github.com/github/gitignore/blob/main/Global/JetBrains.gitignore
#  and can be added to the global gitignore or merged into this file.  For a more nuclear
#  option (not recommended) you can uncomment the following to ignore the entire idea folder.
#.idea/


# Added by cargo

/target
/out
/test
</file>

<file path="README.md">
# SafeMask
This software de-identifies sensitive personal information. After your content is processed by SafeMask, all private information will be anonymized, allowing your information to be safely transmitted and processed on the internet, by AI, etc.

---

# ğŸ›¡ï¸ SafeMask v0.4.1

[![Rust](https://img.shields.io/badge/language-Rust-orange.svg)](https://www.rust-lang.org/)
[![Performance](https://img.shields.io/badge/performance-500MB%2Fs+-green.svg)](#-performance-benchmarks)
[![License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)
[![Platform](https://img.shields.io/badge/platform-Windows%20%7C%20Linux%20%7C%20macOS-lightgrey.svg)](#-installation)

**SafeMask** æ˜¯ä¸€æ¬¾å·¥ä¸šçº§çš„ã€åŸºäº Rust å¼€å‘çš„é«˜æ€§èƒ½éšç§æ•°æ®è„±æ•å·¥å…·ã€‚å®ƒä¸“ä¸º **LLM (å¤§æ¨¡å‹) è®­ç»ƒæ•°æ®æ¸…æ´—**ã€**è·¨å¢ƒæ—¥å¿—å®¡è®¡**ä»¥åŠ**å¼€å‘è€…éšç§ä¿æŠ¤**åœºæ™¯è®¾è®¡ã€‚

**SafeMask** æ˜¯ä¸€æ¬¾åŸºäº Rust å¼€å‘çš„æè‡´æ€§èƒ½éšç§æ•°æ®è„±æ•å·¥å…·ã€‚å®ƒä¸“ä¸ºå¤„ç†å¤§è§„æ¨¡æ—¥å¿—ã€ä»£ç åº“åŠæ•æ„Ÿæ–‡æœ¬è®¾è®¡ï¼Œèƒ½å¤Ÿç¬é—´è¯†åˆ«å¹¶é®ç›– AI API Keysã€æ•°æ®åº“è¿æ¥ä¸²ã€IP åœ°å€ã€æ‰‹æœºå·ç­‰æ•æ„Ÿä¿¡æ¯ï¼Œç¡®ä¿æ•°æ®åœ¨è¿›å…¥ AI æ¨¡å‹æˆ–å…±äº«ç¯å¢ƒå‰çš„åˆè§„æ€§ã€‚
åŒæ—¶, ä¹Ÿå¯ç”¨äº**LLM (å¤§æ¨¡å‹) è®­ç»ƒæ•°æ®æ¸…æ´—**ã€**è·¨å¢ƒæ—¥å¿—å®¡è®¡**ä»¥åŠ**å¼€å‘è€…éšç§ä¿æŠ¤**åœºæ™¯ä¸­ã€‚


## ğŸš€ æ ¸å¿ƒæ¶æ„ï¼šä¸‰é˜¶æ®µä¿åºæµæ°´çº¿ (Level 3 Optimization)

SafeMask ä¸ä»…ä»…æ˜¯ä¸€ä¸ªæ­£åˆ™æ›¿æ¢å·¥å…·ï¼Œå®ƒé‡‡ç”¨äº†å¤æ‚çš„**ç”Ÿäº§è€…-æ¶ˆè´¹è€…æµæ°´çº¿**æ¨¡å‹ï¼Œå®ç°äº† **CPU è®¡ç®—ä¸ I/O è¯»å†™çš„å®Œå…¨é‡å ï¼ˆOverlappingï¼‰**ã€‚

### ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ
```text
[ ç£ç›˜æ–‡ä»¶ ] 
     |
     v
( Stage 1: ç”Ÿäº§è€… ) -> å†…å­˜æ˜ å°„ (Mmap) + æ™ºèƒ½å®åˆ†å— (Macro-Chunking 4MB)
     |
     v
( Stage 2: è®¡ç®—é›†ç¾¤ ) -> Rayon å¹¶è¡Œè®¡ç®— | å­—èŠ‚æµæ­£åˆ™ (Regex Bytes) | AC è‡ªåŠ¨æœº
     |
     v
( Stage 3: æ¶ˆè´¹è€… ) -> ä¼˜å…ˆçº§ç¼“å†²åŒº (BTreeMap) | ä¿åºåˆå¹¶ | 8MB èšåˆå†™å…¥ (BufWriter)
     |
     v
[ è„±æ•è¾“å‡º ]
```


### âš¡ æ·±åº¦ä¼˜åŒ–ç»†èŠ‚
- **Zero-Copy I/O**: ä½¿ç”¨ `memmap2` ç»•è¿‡å†…æ ¸ç¼“å†²åŒºæ‹·è´ã€‚
- **Byte-Level Engine**: åŸºäº `regex::bytes` å®ç°ï¼Œå®Œå…¨è·³è¿‡ UTF-8 æ ¡éªŒå¼€é”€ã€‚
- **Ordered Pipelining**: å¼•å…¥ `crossbeam-channel` ä¸åºåˆ—å·æ§åˆ¶ï¼Œç¡®ä¿é«˜å¹¶å‘ä¸‹çš„æ—¥å¿—è¡Œåºä¸åŸå§‹æ–‡ä»¶ 100% ä¸€è‡´ã€‚
- **Memory Reuse**: é‡‡ç”¨çº¿ç¨‹å±€éƒ¨ç¼“å†²åŒºï¼ˆScratch Buffersï¼‰ï¼Œå°†å†…å­˜åˆ†é…å‹åŠ›ä» $O(N)$ é™ä½åˆ° $O(Threads)$ã€‚

> *æ³¨ï¼šæ€§èƒ½å—é™äºç£ç›˜ I/O ä¸Šé™ã€‚*

## ğŸ“Š æ€§èƒ½åŸºå‡† (Performance Benchmarks)
| æ•°æ®é‡ | åŸå§‹è€—æ—¶ (PS Redirect) | **SafeMask ä¼˜åŒ–è¾“å‡º (-o)** | ååé‡ (Throughput) |
| :--- | :--- | :--- | :--- |
| **113 MB (100ä¸‡è¡Œ)** | 21.9s | **0.42s** | **~270 MB/s** |
| **1.2 GB (500ä¸‡è¡Œ)** | - | **4.1s** | **~300 MB/s** |
| **2.3 GB (1000ä¸‡è¡Œ)** | - | **8.3s** | **~337 MB/s** |

## ğŸ› ï¸ å®‰è£…ä¸ç¼–è¯‘

ç¡®ä¿å·²å®‰è£… Rust ç¯å¢ƒ (MSRV 1.70+)ã€‚

```bash
git clone https://github.com/AiToByte/safemask.git
cd safemask

# å¿…é¡»ä½¿ç”¨ --release æ¨¡å¼ä»¥å¼€å¯æ‰€æœ‰ç¼–è¯‘ä¼˜åŒ–
cargo build --release
```

ç¼–è¯‘äº§ç‰©ä½äº `./target/release/safemask`ã€‚

## ğŸ“– ä½¿ç”¨æŒ‡å—

### 1. å‰ªè´´æ¿æ¨¡å¼
æœ€é€‚åˆåœ¨å°†ä»£ç æˆ–æ—¥å¿—ç²˜è´´ç»™ ChatGPT/Claude å‰ä½¿ç”¨ï¼š
```powershell
./safemask --mode clipboard
```

### 2. æ–‡ä»¶æ¨¡å¼
å¤„ç†å¤§è§„æ¨¡æ—¥å¿—æ–‡ä»¶ï¼Œå¹¶ç›´æ¥è¾“å‡ºåˆ°æŒ‡å®šæ–‡ä»¶ï¼ˆæ¨èï¼‰ï¼š
```powershell
./safemask --mode file --path ./input.log --output ./output_masked.log
```

### 3.æ•ˆæœæ¼”ç¤º
#### 3.1 è¾“å…¥
```txt
INFO [2026-01-09] User_1 (IP: 99.237.89.211) accessed TopSecretProject using sk-47e9a70ff0e240ee9f3a0ebb04e9131f
INFO [2026-01-09] User_2 (IP: 52.158.34.170) accessed TopSecretProject using sk-7eee0e40148040b29a56829556fe0b88
INFO [2026-01-09] User_3 (IP: 225.95.77.71) accessed TopSecretProject using sk-0289c054a0394bb2a99daa44b5d4f4a2
INFO [2026-01-09] User_4 (IP: 49.75.32.104) accessed TopSecretProject using sk-6541c4475bae4ac1a44d9d5813b4575c
INFO [2026-01-09] User_5 (IP: 55.231.84.214) accessed TopSecretProject using sk-5c91dcc325e941b59817789f60cf7bb0
INFO [2026-01-09] User_6 (IP: 210.55.8.24) accessed TopSecretProject using sk-fe044476c8494108881746217929c82c
INFO [2026-01-09] User_7 (IP: 127.183.99.151) accessed TopSecretProject using sk-f2b904e3b686496ca4b88c8698a27818
INFO [2026-01-09] User_8 (IP: 109.143.251.146) accessed TopSecretProject using sk-4c22af8a8da94424a3bd8cbcab30d398
INFO [2026-01-09] User_9 (IP: 250.88.109.70) accessed TopSecretProject using sk-4cd6d738173441d284b0f32141c82fd4
INFO [2026-01-09] User_10 (IP: 118.41.41.205) accessed TopSecretProject using sk-9ac26f750ab741729f4a5813fbe739e8
INFO [2026-01-09] User_11 (IP: 152.38.117.101) accessed TopSecretProject using sk-f0a2b85db0e2404e8ca8b506e1b4f99e
INFO [2026-01-09] User_12 (IP: 145.44.57.211) accessed TopSecretProject using sk-5e0bc7589ad543c785d6cebfc5f2941b
```

#### 3.2 ä½¿ç”¨SafeMaskä¹‹å
```txt
INFO [2026-01-09] User_1 (IP: <IPV4>) accessed TopSecretProject using <DEEPSEEK_KEY>
INFO [2026-01-09] User_2 (IP: <IPV4>) accessed TopSecretProject using <DEEPSEEK_KEY>
INFO [2026-01-09] User_3 (IP: <IPV4>) accessed TopSecretProject using <DEEPSEEK_KEY>
INFO [2026-01-09] User_4 (IP: <IPV4>) accessed TopSecretProject using <DEEPSEEK_KEY>
INFO [2026-01-09] User_5 (IP: <IPV4>) accessed TopSecretProject using <DEEPSEEK_KEY>
INFO [2026-01-09] User_6 (IP: <IPV4>) accessed TopSecretProject using <DEEPSEEK_KEY>
INFO [2026-01-09] User_7 (IP: <IPV4>) accessed TopSecretProject using <DEEPSEEK_KEY>
INFO [2026-01-09] User_8 (IP: <IPV4>) accessed TopSecretProject using <DEEPSEEK_KEY>
INFO [2026-01-09] User_9 (IP: <IPV4>) accessed TopSecretProject using <DEEPSEEK_KEY>
INFO [2026-01-09] User_10 (IP: <IPV4>) accessed TopSecretProject using <DEEPSEEK_KEY>
INFO [2026-01-09] User_11 (IP: <IPV4>) accessed TopSecretProject using <DEEPSEEK_KEY>
INFO [2026-01-09] User_12 (IP: <IPV4>) accessed TopSecretProject using <DEEPSEEK_KEY>
```

## âš™ï¸ è§„åˆ™é…ç½®

è§„åˆ™ä»¥ YAML æ ¼å¼å­˜å‚¨åœ¨ `rules/` ç›®å½•ä¸‹ï¼Œæ”¯æŒå¤šå±‚æ–‡ä»¶å¤¹åˆ†ç±»ï¼š

```yaml
# rules/ai/keys.yaml
group: "AI_API_KEYS"
rules:
  - name: "OpenAI"
    pattern: '\bsk-[a-zA-Z0-9]{48}\b'
    mask: "<OPENAI_KEY>"
    priority: 5 # ä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šå…ˆå¤„ç†
  - name: "DeepSeek"
    pattern: '\bsk-[a-z0-9]{32}\b'
    mask: "<DEEPSEEK_KEY>"
    priority: 20 # ä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šå…ˆå¤„ç†
```

## ğŸ—ï¸ æ¶æ„èƒŒåçš„æ€è€ƒ

ä½œä¸ºä¸€ä¸ªæ‹¥æœ‰ Java èƒŒæ™¯çš„å¼€å‘è€…ï¼Œæˆ‘åœ¨è®¾è®¡ SafeMask æ—¶é‡ç‚¹è§£å†³äº†ä»¥ä¸‹ç—›ç‚¹ï¼š
1. **è§„é¿ GC åœé¡¿**ï¼šé€šè¿‡ Rust çš„æ‰€æœ‰æƒæ¨¡å‹ä¸ `mimalloc` åˆ†é…å™¨ï¼Œæ¶ˆé™¤å¤§è§„æ¨¡å­—ç¬¦ä¸²å¤„ç†ä¸­çš„åœé¡¿ã€‚
2. **é›¶æ‹·è´ I/O**ï¼šä½¿ç”¨ `Mmap` æ›¿ä»£ä¼ ç»Ÿçš„ç¼“å†²è¯»å–ï¼Œå‡å°‘å†…æ ¸æ€ä¸ç”¨æˆ·æ€çš„æ•°æ®æ‹·è´ã€‚
3. **ç®—æ³•èšåˆ**ï¼šé¿å…äº† $N$ æ¬¡ `replace_all` å¯¼è‡´çš„ $O(N \times M)$ å¤æ‚åº¦ï¼Œå°†å…¶ä¼˜åŒ–ä¸º $O(M)$ã€‚

## ğŸ¤ è´¡çŒ®
æˆ‘ä»¬æ¬¢è¿ç¤¾åŒºæäº¤æ–°çš„è„±æ•è§„åˆ™ï¼š
1. åœ¨ `rules/` ä¸‹åˆ›å»ºåˆ†ç±»ç›®å½•ã€‚
2. éµå¾ª `RULES_TEMP.md` ä¸­çš„éç¯è§†æ­£åˆ™è§„èŒƒã€‚
3. æäº¤ PR å¹¶é™„å¸¦æ€§èƒ½æµ‹è¯•ç»“æœã€‚
</file>

<file path="src/main.rs">
mod engine;
mod config;

use anyhow::{Context, Result};
use arboard::Clipboard;
use clap::Parser;
use engine::MaskEngine;
use memmap2::Mmap;
use once_cell::sync::Lazy;
use rayon::prelude::*;
use std::collections::BTreeMap;
use std::fs::File;
use std::io::{self, BufWriter, Write};
use std::path::PathBuf;
use std::time::Instant;

// ä½¿ç”¨ mimalloc æ›¿ä»£é»˜è®¤åˆ†é…å™¨ï¼Œåœ¨é«˜å¹¶å‘ String æ“ä½œä¸‹æ€§èƒ½æ›´ä½³
#[global_allocator]
static GLOBAL: mimalloc::MiMalloc = mimalloc::MiMalloc;

/// å…¨å±€é™æ€å¼•æ“ï¼Œç¡®ä¿è§„åˆ™åªåŠ è½½å’Œç¼–è¯‘ä¸€æ¬¡
static ENGINE: Lazy<MaskEngine> = Lazy::new(|| {
    let rules = config::load_all_rules("rules");
    MaskEngine::new(rules)
});

#[cfg(target_os = "windows")]
const BUFFER_SIZE: usize = 8 * 1024 * 1024; // Windows ä¾§é‡å‡å°‘ç³»ç»Ÿè°ƒç”¨

#[cfg(target_os = "macos")]
const BUFFER_SIZE: usize = 16 * 1024 * 1024; // macOS ä¾§é‡å–‚é¥±é«˜é€Ÿ NVMe

#[cfg(target_os = "linux")]
const BUFFER_SIZE: usize = 4 * 1024 * 1024; // Linux å†…æ ¸é«˜æ•ˆï¼Œ4MB å³å¯ä¿æŒæä½å†…å­˜å ç”¨

#[cfg(not(any(target_os = "windows", target_os = "macos", target_os = "linux")))]
const BUFFER_SIZE: usize = 1024 * 1024; // å…¶ä»–ç³»ç»Ÿé»˜è®¤ 1MB

// 4MB å¹¶è¡Œå—
const MACRO_CHUNK_SIZE: usize = 4 * 1024 * 1024; // 4MB å¹¶è¡Œå—

#[derive(Parser, Debug)]
#[command(name = "safemask", version = "0.4.1", about = "High-performance Data Masking Tool")]
struct Args {
    /// æ¨¡å¼: clipboard (é»˜è®¤) æˆ– file
    #[arg(short, long, default_value = "clipboard")]
    mode: String,

    /// æ–‡ä»¶è·¯å¾„ (ä»… file æ¨¡å¼ä¸‹æœ‰æ•ˆ)
    #[arg(short, long)]
    path: Option<PathBuf>,

     /// [è¾“å‡º] æ–‡ä»¶è·¯å¾„ (å¯é€‰ï¼ŒæŒ‡å®šåå°†ç›´æ¥å†™æ–‡ä»¶è€Œä¸ç»è¿‡ stdout)
    #[arg(short, long)]
    output: Option<PathBuf>,
}


fn main() -> Result<()> {
    let args = Args::parse();

    match args.mode.as_str() {
        "clipboard" => handle_clipboard()?,
        "file" => {
            let path = args.path.context("fileæ¨¡å¼å¿…é¡»ä½¿ç”¨ --path æŒ‡å®šè·¯å¾„")?;
            handle_file_pipeline_ordered(path, args.output)?;
        }
        _ => println!("âŒ æœªçŸ¥æ¨¡å¼ã€‚ è¯·ä½¿ç”¨ --help æŸ¥çœ‹ç”¨æ³•ã€‚")
    }
    Ok(())
}

/// å‰ªåˆ‡æ¿å¤„ç†é€»è¾‘
fn handle_clipboard() -> Result<()> {
    let mut clipboard = Clipboard::new().context("æ— æ³•è¿æ¥å‰ªè´´æ¿")?;
    let input = clipboard.get_text().context("å‰ªè´´æ¿ç©º")?;
    println!("ğŸš€ æ­£åœ¨å¤„ç†å‰ªè´´æ¿æ•°æ®...");
    let output_bytes = ENGINE.mask_line(input.as_bytes());
    let output_text = String::from_utf8_lossy(&output_bytes).into_owned();
    clipboard.set_text(output_text).context("å›å†™å¤±è´¥")?;
    println!("âœ… è„±æ•æˆåŠŸï¼");
    Ok(())
}

/// æ–‡ä»¶æ¨¡å¼ï¼šä¸‰é˜¶æ®µä¿åºæµæ°´çº¿ (Mmap -> Rayon -> BTreeMap -> Writer)
fn handle_file_pipeline_ordered(input_path: PathBuf, output_path: Option<PathBuf>) -> Result<()> {
    let global_start = Instant::now();
    let file = File::open(&input_path)?;
    let mmap = unsafe { Mmap::map(&file)? };
    let file_size = mmap.len();

    // 1. æ„å»ºè·¨çº¿ç¨‹é€šä¿¡é€šé“
    let (tx, rx) = crossbeam_channel::bounded::<(usize, Vec<u8>)>(rayon::current_num_threads() * 2);

    // 2. å¯åŠ¨ Stage 3: é¡ºåºå†™å…¥çº¿ç¨‹
    let writer_handle = std::thread::spawn(move || -> Result<()> {
        let writer_target: Box<dyn Write> = if let Some(p) = output_path {
            Box::new(File::create(p)?)
        } else {
            Box::new(io::stdout())
        };
        let mut writer = BufWriter::with_capacity(BUFFER_SIZE, writer_target);
        let mut next_idx = 0;
        let mut pending_map: BTreeMap<usize, Vec<u8>> = BTreeMap::new();

        while let Ok((idx, data)) = rx.recv() {
            pending_map.insert(idx, data);
            while let Some(data) = pending_map.remove(&next_idx) {
                writer.write_all(&data)?;
                next_idx += 1;
            }
        }
        writer.flush()?;
        Ok(())
    });

    println!("ğŸš€ æµæ°´çº¿å¯åŠ¨ | æ ¸å¿ƒæ•°: {} | æ–‡ä»¶: {:.2} MB", 
             rayon::current_num_threads(), file_size as f64 / 1024.0 / 1024.0);

    // 3. Stage 1 & 2: ç”Ÿäº§è€…ä¸å¹¶è¡Œè®¡ç®—
    mmap.par_chunks(MACRO_CHUNK_SIZE)
        .enumerate()
        .for_each(|(idx, chunk)| {
            // é¢„åˆ†é…å†…å­˜ï¼šåŸå§‹å—å¤§å° + 5% ç¼“å†²åŒºç”¨äºå­˜æ”¾è„±æ•æ ‡ç­¾
            let mut chunk_output = Vec::with_capacity(chunk.len() + chunk.len() / 20);
            // å—å†…æŒ‰è¡Œåˆ‡å‰²å¹¶è„±æ•
            for line in chunk.split(|&b| b == b'\n') {
                if !line.is_empty() {
                    let masked = ENGINE.mask_line(line);
                    chunk_output.extend_from_slice(&masked);
                }
                chunk_output.push(b'\n'); // ä¿æŒè¡Œç»“æ„
            }
            let _ = tx.send((idx, chunk_output));
        });

    // 4. å…³é—­é€šé“å¹¶ç­‰å¾…ç»“æŸ 
    // å¿…é¡»æ‰‹åŠ¨é‡Šæ”¾ txï¼Œå¦åˆ™ rx ä¼šæ­»é”
    drop(tx);
    writer_handle.join().unwrap()?;

    let total_time = global_start.elapsed();
    println!("\n--- âš¡ SafeMask v{} æ€§èƒ½æŠ¥å‘Š ---", env!("CARGO_PKG_VERSION"));
    println!("â±ï¸  æ€»æ‰§è¡Œæ—¶é—´: {:?}", total_time);
    println!("ğŸš€ æé™ååé‡: {:.2} MB/s", (file_size as f64 / 1024.0 / 1024.0) / total_time.as_secs_f64());
    Ok(())
}


// /// æ–‡ä»¶æ¨¡å¼ï¼šé€šè¿‡ IndexedParallelIterator ä¿è¯è¡Œé¡ºåº
// #[allow(dead_code)]
// fn handle_file_ordered(input_path: PathBuf, output_path: Option<PathBuf>) -> Result<()> {
//     let global_start = Instant::now();

//     // 1. å†…å­˜æ˜ å°„è¾“å…¥æ–‡ä»¶ (è¯»å–æœ€å¿«æ–¹æ¡ˆ)
//     let file = File::open(&input_path).with_context(|| format!("æ— æ³•æ‰“å¼€è¾“å…¥æ–‡ä»¶: {:?}", input_path))?;
//     let mmap = unsafe { Mmap::map(&file)? };
//     let file_size = mmap.len();
//     let load_time = global_start.elapsed();

//     println!("ğŸš€ å¼•æ“åŠ è½½æˆåŠŸ | çº¿ç¨‹æ± å¤§å°: {} | æ–‡ä»¶å¤§å°: {:.2} MB", 
//              rayon::current_num_threads(),
//              file_size as f64 / 1024.0 / 1024.0);

//     // 2. å¹¶è¡Œæ˜ å°„ (Map) + ä¿åºæ”¶é›† (Collect)
//     // Rayon çš„ collect ä¼šä¿è¯æœ€ç»ˆç”Ÿæˆçš„ Vec é¡ºåºä¸åŸå§‹åˆ‡åˆ†é¡ºåºå®Œå…¨ä¸€è‡´
//     let processed_results: Vec<String> = mmap
//         .par_split(|&b| b == b'\n')
//         .map(|chunk| {
//             // å°†å­—èŠ‚åˆ‡ç‰‡è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼ˆé›¶æ‹·è´å°è¯•ï¼‰
//             let line = String::from_utf8_lossy(chunk);
//             // æ ¸å¿ƒè„±æ•è®¡ç®— (CPU å¯†é›†å‹)
//             ENGINE.mask_line(&line).into_owned()
//         })
//         .collect();

//     let process_time = global_start.elapsed() - load_time;

//     // 3. é¡ºåºå†™å…¥ (Sequential Write)
//     // æ­¤æ—¶å·²ç»å¾—åˆ°äº†æœ‰åºçš„ Vec<String>ï¼Œç›´æ¥é¡ºåºå†™å…¥ç£ç›˜
//     let writer_target: Box<dyn Write> = if let Some(out_p) = output_path {
//         Box::new(File::create(&out_p)?)
//     } else {
//         Box::new(io::stdout())
//     };

//     let mut writer = BufWriter::with_capacity(1024 * 1024, writer_target);
//     for line in processed_results {
//         writeln!(writer, "{}", line)?;
//     }
//     writer.flush()?;

//     // 4. æ€§èƒ½æŠ¥å‘Š
//     let total_time = global_start.elapsed();
//     let throughput = (file_size as f64 / 1024.0 / 1024.0) / total_time.as_secs_f64();

//     println!("\n--- âš¡ SafeMask æ€§èƒ½åˆ†ææŠ¥å‘Š ---");
//     println!("ğŸ“‚ IO è¯»å–/æ˜ å°„è€—æ—¶: {:?}", load_time);
//     println!("âš™ï¸  å¹¶è¡Œä¿åºè®¡ç®—è€—æ—¶: {:?}", process_time);
//     println!("â±ï¸  æ€»è®¡è¿è¡Œæ—¶é—´    : {:?}", total_time);
//     println!("ğŸš€ å¹³å‡ä¿åºååé‡  : {:.2} MB/s", throughput);
//     println!("--------------------------------------");

//     Ok(())
// }
</file>

</files>
