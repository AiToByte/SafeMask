# 🛡️ SafeMask 架构详解 (Part 4: 系统集成、剪贴板监控与桌面安全)

这是 SafeMask 架构文档的最后一章。我们将探讨 Rust 后端如何与系统环境深度集成，以及如何通过响应式状态管理为用户提供流畅、安全的桌面体验。


## 1. 剪贴板隐私盾 (Clipboard Privacy Shield)

剪贴板脱敏是 SafeMask 的“静默保护”核心。为了在不阻塞系统响应的前提下实现实时拦截，我们设计了一套完善的监控逻辑。

### A. 智能轮询与变更检测
在 `infra/clipboard/monitor.rs` 中，SafeMask 并没有使用复杂的系统级 Hook（以保证跨平台稳定性），而是采用了 **高性能异步轮询 (Polling)**：
*   **频率控制**：每 500ms 扫描一次剪贴板，在 CPU 占用与响应速度间取得平衡。
*   **去重逻辑**：通过 `last_content` 缓存机制，仅在内容发生真实变化时才触发脱敏引擎。

### B. 防环死锁机制 (Recursive Protection)
脱敏引擎修改剪贴板本身也是一种“变更”，若不加控制会触发无限循环。
*   **原子标记 (`is_internal_changing`)**：在写回脱敏内容前，后端会设置一个原子布尔标记。
*   **逻辑跳过**：监控线程在检测到变更时，若发现内部标记为 `true`，则直接忽略。
*   **自愈恢复**：通过 `tokio::time::sleep` 延迟 300ms 后重置标记，确保后续的人为复制能被再次捕获。

---

## 2. 跨语言状态同步 (State Management)

SafeMask 需要在 Rust 后端的高并发环境与 Vue 前端的响应式界面间同步数据。

### A. Rust 端的线程安全状态 (`AppState`)
使用 `Arc` 与 `parking_lot` 提供的轻量级锁，确保多线程下数据的完整性：
*   **`SharedEngine`**：使用 `RwLock<Arc<MaskEngine>>`，支持“多读一写”，允许在不停止应用的情况下热重载脱敏规则。
*   **`history`**：受 `Mutex` 保护的环形缓冲区（Ring Buffer），自动清理老旧记录，防止内存溢出。

### B. 事件驱动模型 (Event-Driven)
后端利用 Tauri 的 `Emitter` 机制实现 **“主动推送”**：
*   **`file-progress`**：多线程文件处理时，定时向 UI 推送百分比。
*   **`new-history`**：剪贴板拦截发生时，立即通知前端更新列表。
*   **`masked-event`**：触发系统级 Toast 通知（通过 `tauri-plugin-notification`）。

---

## 3. 动态配置加载器 (Rule Loader)

SafeMask 实现了 **“配置即资源”** 的动态加载体系。

*   **内置 vs 自定义**：
    *   `rules/` 目录存放随软件发布的系统级规则（只读）。
    *   `custom/` 目录存放用户通过 UI 创建的私有规则（持久化为 YAML）。
*   **打包适配**：利用 `app_handle.path().resource_dir()` 动态定位资源路径，确保应用在打包成 `.exe` 或 `.dmg` 后依然能正确读取 YAML 配置文件。

---

## 4. 桌面安全与零信任 (Security)

作为一款隐私工具，SafeMask 在系统集成层面实施了严苛的安全策略：

1.  **100% 离线保证**：在 `tauri.conf.json` 中未配置任何网络插件，且代码中完全不包含 `reqwest` 或网络相关库，从根源消除数据外泄路径。
2.  **窗口关闭拦截**：在 `main.rs` 中拦截窗口关闭事件，引导用户选择“最小化到托盘”而非彻底关闭，从而维持剪贴板监控的持续性。
3.  **权限最小化 (Capabilities)**：在 `capabilities/default.json` 中显式声明权限，仅开启文件对话框、通知、托盘和剪贴板访问权，严格遵循最小特权原则。

---

## 5. 总结：SafeMask 的全链路流程

```text
[ 用户复制内容 ] 
      |
( infra/clipboard/monitor ) -> 检测到变更
      |
( core/engine ) -------------> 执行混合匹配与冲突合并算法
      |
( common/state ) ------------> 存储历史记录 (Thread-safe)
      |
( tauri::Emitter ) ----------> 发送事件给前端
      |
( Vue 3 / Pinia ) -----------> UI 自动响应，展示脱敏对比与拦截通知
```